#!/data/data/com.termux/files/usr/bin/sh

ROOT=$(realpath "$(dirname "$0")/..")
CONFIG="$ROOT/config.local.json"

USE_PROOT=$(jq -r '.use_proot_workaround' "$CONFIG")
SATELLITE_NAME=$(jq -r '.satellite_name' "$CONFIG")

CMD=$(cat <<EOF
pactl unload-module module-sles-source || true &&
pactl load-module module-sles-source &&

python3 script/run \
  --name "$SATELLITE_NAME" \
  --uri tcp://0.0.0.0:10700 \
  --mic-command 'rec -r 16000 -c 1 -b 16 -e signed-integer -t raw --no-show-progress -' \
  --snd-command 'play -r 22050 -c 1 -b 16 -e signed-integer -t raw --no-show-progress -' \
  --wake-uri 'tcp://10.0.0.7:10400' \
  --wake-word-name 'alexa' \
  --awake-wav 'sounds/awake.wav' \
  --timer-finished-wav 'sounds/timer_finished.wav' \
  --debug
EOF
)

pulseaudio -k && || true
pulseaudio --start

if [ "$USE_PROOT" = true ]; then
  pactl unload-module module-native-protocol-tcp || true
  pactl load-module module-native-protocol-tcp auth-anonymous=1
  proot-distro login ubuntu -- bash -c "
    export PULSE_SERVER=127.0.0.1 &&
    cd /data/data/com.termux/files/home/android-satellite/wyoming-satellite &&
    $CMD
  "
else
  cd "$ROOT/wyoming-satellite"
  bash -c "$CMD"
fi