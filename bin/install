#!/data/data/com.termux/files/usr/bin/sh

ROOT=$(realpath "$(dirname "$0")/..")
export PATH=$PATH:/data/data/com.termux/files/usr/bin

SNAPCAST_VERSION="0.31.0"
SNAPCLIENT_FILE="snapclient.deb"

ARCH=$(dpkg --print-architecture 2>/dev/null || echo "armhf")
if [ "$ARCH" = "arm64" ]; then
  SNAPCLIENT_URL="https://github.com/badaix/snapcast/releases/download/v${SNAPCAST_VERSION}/snapclient_${SNAPCAST_VERSION}-1_arm64_bookworm_with-pulse.deb"
else
  SNAPCLIENT_URL="https://github.com/badaix/snapcast/releases/download/v${SNAPCAST_VERSION}/snapclient_${SNAPCAST_VERSION}-1_armhf_bookworm_with-pulse.deb"
fi

termux-change-repo

pkg upgrade -y
pkg install \
  helix fish curl wget \
  git openssh nodejs-lts \
  which termux-api syncthing \
  python3 pulseaudio jq -y

npm install pm2 -g

mkdir -p ~/.termux/boot/
rm -rf ~/.termux/boot/startup
cp "$ROOT/bin/termux-boot" ~/.termux/boot/startup
chmod +x ~/.termux/boot/startup

pm2 start --interpreter=none syncthing
sleep 5
pm2 delete syncthing
sed -i 's/127\.0\.0\.1:8384/0.0.0.0:8384/' ~/.local/state/syncthing/config.xml

passwd
chsh -s fish

sh -c "cd $ROOT && git submodule update --init --recursive"

pkg install proot-distro -y
proot-distro install debian || true
proot-distro login debian -- bash -c "
  ln -s /data/data/com.termux/files/home/android-satellite /root/android-satellite &&
  apt update &&
  apt install curl wget -y &&
  curl -fsSL https://deb.nodesource.com/setup_20.x | bash - &&
  apt install nodejs python3 python3-pip python3-venv pamixer pulseaudio sox -y &&
  cd /root/android-satellite/wyoming-satellite &&
  python3 script/setup &&
  cd /root/android-satellite/devicectl-api &&
  npm install &&
  cd /root &&
  wget -O $SNAPCLIENT_FILE $SNAPCLIENT_URL &&
  apt install -y ./$SNAPCLIENT_FILE
"
