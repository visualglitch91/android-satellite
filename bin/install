#!/data/data/com.termux/files/usr/bin/sh

ROOT=$(realpath "$(dirname "$0")/..")
export PATH=$PATH:/data/data/com.termux/files/usr/bin

# Update Termux repository to North America mirror
termux-change-repo

# Upgrade packages and install dependencies
pkg upgrade -y
pkg install \
  helix fish curl wget \
  git openssh nodejs-lts \
  which termux-api syncthing \
  python3 sox pulseaudio jq -y

npm install pm2 -g

# Remove existing Termux boot startup script and create symbolic link to custom script
mkdir -p ~/.termux/boot/
rm -rf ~/.termux/boot/startup
cp "$ROOT/bin/termux-boot" ~/.termux/boot/startup
chmod +x ~/.termux/boot/startup

# Start syncthing to generate config, then stop it and modify config file to listen on all interfaces
pm2 start --interpreter=none syncthing
sleep 5
pm2 delete syncthing
sed -i 's/127\.0\.0\.1:8384/0.0.0.0:8384/' ~/.local/state/syncthing/config.xml

# Prompt user to set SSH login password
passwd

# Change default shell to fish shell
chsh -s fish

# Prompt for MQTT host and satellite name
read -r -p "Enter MQTT host: " mqtt
read -r -p "Enter satellite name: " name

# Ask whether to use proot-distro
read -r -p "Use proot-distro? (y/n): " use_proot
use_proot=$(echo "$use_proot" | tr '[:upper:]' '[:lower:]')

if [ "$use_proot" = "y" ] || [ "$use_proot" = "yes" ]; then
  use_proot_value=true
else
  use_proot_value=false
fi

# Save configuration to .config.json
echo "{\"MQTT_HOST\": \"$mqtt\", \"SATELLITE_NAME\": \"$name\", \"USE_PROOT\": $use_proot_value}" > "$ROOT/.config.json"

# Initialize git submodules and install dependencies for devicectl-api and wyoming-satellite
sh -c "cd $ROOT && git submodule update --init --recursive"
sh -c "cd $ROOT/devicectl-api && npm install"

if [ "$use_proot_value" = true ]; then
  pkg install proot-distro -y
  proot-distro install ubuntu || true
  proot-distro login ubuntu -- bash -c "
    apt update &&
    apt install python3 python3-pip python3.12-venv pulseaudio sox -y &&
    cd /data/data/com.termux/files/home/android-satellite/wyoming-satellite &&
    python3 script/setup
  "
else
  sh -c "cd $ROOT/wyoming-satellite && python3 script/setup"
fi

chmod +x $ROOT/bin/*

# Restart all pm2-managed processes using ecosystem config and save process list
pm2 restart "$ROOT/ecosystem.config.js"
pm2 save --force
